<script src="~/Scripts/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
  var browserOnlyExts = ['jpg', 'jpeg', 'png', 'gif'];
  var sourceOnlyExts = ['css', 'js'];
  var sourceModes = {};
  sourceModes['css'] = 'ace/mode/css';
  sourceModes['js'] = 'ace/mode/javascript';
  var defaultSourceMode = 'ace/mode/html';
  var sourceHref = '';
  var browseRoot = '@Model';

  var _augerResize = function () {
    $('.full-height').each(function () {
      $(this).height($(window).innerHeight() - this.getBoundingClientRect().top);
    });
    //$('#full-div').height($(window).innerHeight() - $('#full-div').position().top);
    //$('#editor-div').height($(window).innerHeight() - $('#editor-div').get(0).getBoundingClientRect().top);
    //$('#browser-div').height($('#full-div').innerHeight() - $('#browser-div').position().top);
    //$('#folder-div').height($('#full-div').innerHeight() - $('#folder-div').position().top);
    if (!!editor) { editor.resize(); }
  };
  $(window).resize(_augerResize);

  $(function () {
    _augerResize();

    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      //var target = $(e.target).attr("href") // activated tab
      _augerResize();
    });

    $('#browser').load(function () {
      var href = $('#browser')[0].contentWindow.location.href;
      $('#buttonOpenInNewWindow').attr('href', href);
      var path = href.split(browseRoot)[1];
      $('#file-name').html(path);
      var parts = path.split('.');
      var ext = parts[parts.length - 1];
      if (browserOnlyExts.indexOf(ext) > -1) {
        $('#tabBrowser').tab('show');
        $('#tabSource').hide();
        return;
      }
      if (sourceModes[ext] == undefined) {
        editor.getSession().setMode(defaultSourceMode);
      } else {
        editor.getSession().setMode(sourceModes[ext]);
      }
      if (sourceOnlyExts.indexOf(ext) > -1) {
        $('#tabSource').tab('show');
        $('#tabBrowser').hide();
      }
      loadSource();
    });

    $('.file-button').click(function () {
      $('#tabSource').show();
      $('#tabBrowser').show();
      $('#browser').attr('src', browseRoot + $(this).attr('href'));
      return false;
    });

    $('#buttonDefaultFile').click();

    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      if (e.target.id === 'tabSource') {
        loadSource();
      }
    })
  });

  function loadSource(href) {
    var href = $('#browser')[0].contentWindow.location.href;
    if (sourceHref !== href) {
      editor.setValue('UNABLE TO LOAD PAGE SOURCE');
      getFile(href, function (text) {
        editor.setValue(text);
        editor.gotoLine(0);
        sourceHref = href;
      });
    }
  }

  var editor = ace.edit('editor');
  editor.setReadOnly(true);
  editor.setTheme('ace/theme/monokai');
  editor.setFontSize(16);
  editor.getSession().setMode(defaultSourceMode);
  editor.setValue('UNABLE TO LOAD PAGE SOURCE');

  var getAsRelative = function (url) {
    var pageUri = URI(window.location.href);
    return URI(url).relativeTo(pageUri);
  }

  var getIsRelative = function (url) {
    return url.toString().indexOf("//") == -1;
  }

  var getFile = function (url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        callback(xhr.responseText, url);
      }
    }
    xhr.send();
  };
</script>

